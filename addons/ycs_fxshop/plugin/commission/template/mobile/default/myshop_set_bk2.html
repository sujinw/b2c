{template 'common/header'}
<title>小店设置</title>
<script src="../addons/ycs_fxshop/static/js/dist/ajaxfileupload.js" type="text/javascript"></script>
<style type="text/css">
    body {margin:0px; background:#efefef; font-family:'微软雅黑'; -moz-appearance:none;}
    a {text-decoration:none;}
    .myshop_topbar {height:40px; width:94%; padding:0px 3%; background:#f9f9f9; border-bottom:1px solid #e8e8e8; font-size:16px; line-height:40px; text-align:center; color:#666;}
    .myshop_topbar a {height:40px; width:15px; display:block; float:left; outline:0px; color:#999; font-size:24px;}
    .myshop_addnav {height:44px; width:94%; padding:0 3%; border-bottom:1px solid #f0f0f0; border-top:1px solid #f0f0f0; margin-top:14px; line-height:42px; color:#666; background:#fff;}
    .myshop_addnav {height:40px; width:94%; padding:0 3%; border-bottom:1px solid #f0f0f0; border-top:1px solid #f0f0f0; margin-top:14px; line-height:40px; color:#666; }
.myshop_main {height:auto;width:94%; padding:0px 3%; border-bottom:1px solid #f0f0f0; border-top:1px solid #f0f0f0; margin-top:14px; background:#fff;}
.myshop_main .line {height:44px; width:100%; border-bottom:1px solid #f0f0f0; line-height:44px;}

.myshop_main .line .label { float:left;width:70px;}
.myshop_main .line .info { float:right; width:100%; margin-left:-75px;text-align: right;overflow:hidden;height:44px;}
.myshop_main .line .info .inner { color:#666;margin-left:75px;}

.myshop_main .line1 {height:80px; width:100%; border-bottom:1px solid #f0f0f0; line-height:80px;}
.myshop_main .line1 .label { float:left;width:70px;}
.myshop_main .line1 .info { float:right; width:100%; margin-left:-75px;;overflow:hidden;height:80px;}
.myshop_main .line1 .info .inner { color:#666;margin-left:75px;padding-top:10px;}
.myshop_main .line1 .info .inner .plus { float:left;width:60px;height:60px;border:1px solid #efefef; color:#efefef;; font-size:45px;line-height:55px;text-align:center;}
.myshop_main .line1 .info .inner .plus1 { float:left;width:90%;height:60px;border:1px solid #efefef; color:#efefef;; font-size:45px;line-height:55px;text-align:center;}

.myshop_main .line1 .info .inner .preview0 { position:absolute; width:60px;height:60px;z-index:2}
.myshop_main .line1 .info .inner .preview1 { position:absolute; width:100%;height:60px;z-index:2}

.myshop_main .line1 .info .inner .preview0 img,.myshop_main .line1 .info .inner .preview1 img { width:100%;height:100%;}

.myshop_main .line input {float:left; height:44px; width:100%; padding:0px; margin:0px; border:0px; outline:none; font-size:16px; color:#666;padding-left:5px;}
.myshop_main .line select  {float:left; border:none;height:25px;width:100%;color:#666;font-size:16px;margin-top:10px;}
.myshop_sub1 {height:44px; width:94%; margin:14px 3% 0px; background:#ff4f4f; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
.myshop_sub2 {height:44px; width:94%; margin:14px 3% 0px; background:#ddd; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#666; border:1px solid #d4d4d4;}

.myshop_main .line2 {width:100%;  line-height:25px; color:#666;overflow:hidden; font-size:13px;word-break: break-all;}

textarea {height:60px;line-height:22px; width:100%;padding:5px;font-size:13px; background:#fff; padding-left:2%; border:1px solid #e9e9e9; margin:14px 0px 0; -webkit-appearance: none;}
.hide{display: none}


</style>
<div id='container'></div>

<script id='tpl_main' type='text/html'>
  <div class="myshop_topbar"><a href="javascript:;" onclick="history.back()"><i class="fa fa-angle-left"></i></a>
            小店设置
 </div>
 <div class="myshop_main" >



          <div class="line">
            <div class="label">小店名称</div>
            <div class="info">
              <div class="inner">
                <input type="text" id="shopname" value="<%shop.name%>"/>
              </div>
            </div>
          </div>

          <div class="line1">
            <div class="label">小店头像</div>
              <div class="info">
                <div class="inner">
                  <div class="plus" style="position:relative;">
                      <input type="file" data-tag="0" onchange="uploadface(this)" name='uploadImgFile' id='imgFile0' style="position:absolute;left:0;z-index:3;width:60px;height:60px;-webkit-tap-highlight-color: transparent;filter:alpha(Opacity=0); opacity: 0;" />
                      <%if shop.logo==''%><i class="fa fa-plus"  style="position:absolute;top:10px;right:12px;z-index:1"></i><%/if%>
                      <input type="hidden" id="img0" />
                      <div id="preview0" class="preview">
                          <%if shop.logo!=''%><img src='<%shop.logo%>' width='100%' height='100%' /><%/if%>
                      </div>
                  </div>
              </div>
            </div>
          </div>

          <div class="line1" style="height:110px;">
            <div class="label">小店店招</div>
              <div class="info">
                <div class="inner">
                  <div class="plus1" style="position:relative;">
                    <input type="file" data-tag="1" onchange="uploadface(this)" name='uploadImgFile' id='imgFile1' style="position:absolute;left:0;z-index:3;width:100%;height:60px;-webkit-tap-highlight-color: transparent;filter:alpha(Opacity=0); opacity: 0;" />
                      <%if shop.img==''%><i class="fa fa-plus"  style="position:absolute;top:10px;right:40%;z-index:1"></i><%/if%>
                    <input type="hidden" id="img1" />
                    <div id="preview1" class="preview">
                          <%if shop.img!=''%><img src='<%shop.img%>' width='100%' height='60px' /><%/if%>
                    </div>
                  </div>
                </div>
              </div>
              <span style="position: relative;top: -29px;left: 76px;color:#bbb;font-size:12px;">建议上传长宽比 3:2 的图片
              </span>
            </div>
            <div class="line2">
              <textarea id="desc" placeholder="小店简介,分享你的小店"><%shop.desc%></textarea>
            </div>
          </div>
        <div class="myshop_sub1" id='myshop_submit'>确认</div>
</script>
 <script id="tpl_img" type="text/html">
     <img src='<%url%>' tag="<%tag%>" img='<%filename%>'/>
</script>

<script language="javascript">

    require(['tpl', 'core'], function(tpl, core) {

           core.pjson('commission/myshop',{op:'set'},function(json){


                         $('#container').html(  tpl('tpl_main',json.result) );


                            $('#myshop_submit').click(function(){
                               if($(this).attr('saving')=='1'){
                                   return;
                               }

                                $(this).html('正在处理...').attr('saving',1);
                                var shopdata = {
                                        name: $('#shopname').val(),
                                        desc: $('#desc').val()
                                }
                                if(!$('#img0').isEmpty()){
                                    shopdata.logo = $('#img0').val();
                                }
                                if(!$('#img1').isEmpty()){
                                    shopdata.img = $('#img1').val();
                                }

                                core.pjson('commission/myshop',{
                                    op:'set',
                                    shopdata:shopdata
                                 },function(postjson){
                                     if(postjson.status==1){
                                         history.back();
                                     }
                                     else{
                                         $(this).html('确认').removeAttr('saving');
                                         core.tip.show('操作失败');
                                     }
                                },true,true);

                           });

                            //上传图片


           },true);

    })
</script>
<script type="text/javascript">
            // function upimg (obj) {
            //     require(['tpl', 'core'], function(tpl, core) {
            //         if(obj.files[0].size>1024*2000){
            //             alert('上传图片超过限制,请上传2M以下的图片');
            //             return;
            //         }

            //         core.loading('正在上传');

            //         var tag= $(this).data('tag');

            //         $.ajaxFileUpload({
            //             url: core.getUrl('util/uploader'),
            //             data: {file: "imgFile" + tag},
            //             secureuri: false, //异步
            //             fileElementId: 'imgFile'+ tag, //上传控件ID
            //             dataType: 'json', //返回的数据信息格式
            //             success: function(res, status) {
            //                 core.removeLoading();
            //                 var obj = $(tpl('tpl_img', res));
            //                 $('.preview' + tag).html(obj);
            //                 $('#img' + tag).val( res.filename );
            //             }, error: function(data, status, e) {
            //                 core.removeLoading();
            //                 core.tip.show('上传失败!');
            //             }
            //         });
            //     });
            // };
</script>

<script type="text/javascript">

        //上传头像 开始
        function uploadface(obj){
            //检查文件类型
            var faceVal = jQuery(obj).val();

            var faceValArr = faceVal.split(".");
            var faceFileType = faceValArr[faceValArr.length - 1];
            if(faceFileType != "jpg" && faceFileType != "png" && faceFileType != "jpeg"){
                alert("只能上传jpg,png,jpeg等格式图片");
                return false;
            }
            if(obj.files[0].size>1024*2000){
                alert('上传图片超过限制,请上传2M以下的图片');
                return;
            }

            var fd = new FormData(); // html5新增的对象,可以包装字符,二进制信息
            fd.append(obj.name,obj.files[0]);

            upload(fd,obj);
        }
        function upload(fd,ab) {
            var xhr = new XMLHttpRequest();
            var mode = 1;//用户在传照片
            xhr.open('POST','{php echo $this->createMobileUrl("iframeWithUploadImg")}',true); // 异步传输
            // xhr.upload 这是html5新增的api,储存了上传过程中的信息
            xhr.upload.onprogress = function(ev){
                var percent = 0;
                if(ev.lengthComputable) {
                    percent = (100 * ev.loaded/ev.total).toFixed(2);

                    if(percent == 100.00){
                        percent = 100;
                    }


                }
            }

            xhr.onreadystatechange=function(){
                if (xhr.readyState==4){

                    if(xhr.status==200){

                        var back = xhr.responseText;

                        if(back == "1"){
                            alert("上传头像的图片格式错误!");
                            return false;

                        }else if(back == "2"){
                            alert("上传头像发生未知错误!");
                            return false;
                        }else if(back == "3"){
                            alert("存储头像发生错误!");
                            return false;
                        }else{
                            var obj = eval("(" + back + ")");

                            var imgUrl = '{$_W["attachurl"]}'+obj.imgPath;
                            var im = obj.imgPath;
                            // $('.upimg').attr("src",imgUrl);
                            jQuery(ab).siblings('.preview').find('img').attr("src",imgUrl).show();
                            jQuery(ab).siblings('i').addClass('hide');
                            jQuery(ab).siblings('input[type="hidden"]').val(im);

                        }
                    }else if(xhr.status==503){
                        alert("上传头像超时!");
                        return false;
                    }else{
                        alert("上传头像发生未知错误!");
                        return false;
                    }
                }
            }
            xhr.send(fd);


        }

    //上传头像 结束

</script>
{template 'common/footer'}